# SLA Mediator User Guide #

* [Introduction](#intro)
* [Creator](#creator)
* [Starter](#starter)
* [Modelio](#modelio)
* [Customer-ApplicationProvider Template generation](#c-ap-template)
* [Agreement generation](#agreement)

## <a name="intro">Introduction</a> ##

The SLA Mediator is the component of the SLA Tool that acts as a bridge 
between the output of the Modelio Tool and the ws-agreement format understood 
by the SLA Core component.

The purpose of the Mediator is to generate the template and agreement needed
in the two SLA levels contemplated in the MODAClouds project: 

* Customer - Application Provider SLA,
* Application Provider - Cloud Provider SLA.

The data needed to generate these ws-agreement entities are:

* PCM models,
* Constraints definition,
* Monitoring rules definition.

Currently, only the _Customer - Application Provider_ SLA is supported.

## <a name="creator">Creator</a> ##

The Creator is a command line application that creates agreements/templates 
and stores them in the SLA Core.

The available options are:

    [--consumer] : Consumer identifier. If not specified, it only generates the template.
    --user value : Sla Credentials (user:password)
    --dir value : Directory where to find xml files
    [--duration value] : xs:duration with the agreement validity. Default to 'P1Y'
    --provider value : Provider name
    [--service -s value] : Service Name. Default to 'modaclouds'
    --url value : Sla Core Url

So, for example, a valid invocation is:

    $ java -cp target/sla-mediator-jar-with-dependencies.jar eu.modaclouds.sla.mediator.Creator
      --url http://localhost:8080/sla-service 
      --user user:password 
      --dir src/test/resources/ 
      --provider ATOS
      --consumer BancoSantander

## <a name="starter">Starter</a> ##

The Starter is a command line application that starts the enforcement of 
existing agreements.

The options available are:

    --id value : Agreement Id
    [--callback value] : Callback Url. If not set, fallback to $sla/metrics
    [--user -u value] : Sla Credentials (user:password)
    [--dir -d value] : Directory where to find xml files. 
        If not specified, tries to retrieve OutputMetric information from agreement
    [--metrics value] : Monitoring Platform Metrics Url
    [--sla value] : Sla Core Url
    
The Starter program may use the following ENV vars:

* `SLA_CORE_URL`: Url of Sla Core component (e.g. `http://localhost:8080/sla-service`)
* `SLA_CORE_CREDENTIALS`: Credentials to authenticate to Sla Core (e.g. `user:password`)
* `MONITORING_METRICS_URL`: Monitoring Platform Metrics Url (e.g. `http://localhost:8170/v1/metrics`)

Starter options override env vars. If any env var is not used, the corresponding option MUST be specified.

A valid invocation is:

    $ export MONITORING_METRICS_URL=http://localhost:8170/v1/metrics
    $ export SLA_CORE_URL=http://localhost:8080/sla-service 
    $ java -cp target/sla-mediator-jar-with-dependencies.jar eu.modaclouds.sla.mediator.Starter
      --id 0d95636f-fe41-4f2c-a0d6-1bbeb470641
      --sla http://eu.modaclouds.sla:8080/sla-service 
      --user user:password 


## <a name="modelio">Modelio</a> ##

(Work in progress)

## <a name="c-ap-template">Customer-ApplicationProvider template generation</a> ##

For the Customer - Application Provider SLA, only the high level constraints are being considered, i.e. 
constraints that directly affects the end user. A clear example is a constraint where the 
Application Provider wants to offer an availability of 99.9% to the Customer.

The details of the generation are:

*   An autogenerated UUID is assigned as TemplateId.
*   The context is filled with the following data:
    * service provider
    * name of service
*   There is one guarantee term for each constraint that have `InternalComponent` or 
    `Method` as value in its `targetClass` attribute.

    The scope of the guarantee term is a readable representation of the targetResourceIDRef attribute. 
    If the targetClass is `InternalComponent`, the scope is the name of the referenced component. If the targetClass 
    is `Method`, the scope is the concatenation of the name of the component containing the method, and the 
    referenced method's name.

    The service level of the agreement contains two attributes:

    * qos: represents the original modeled QoS, 
    * constraint: contains the name of the associated QoS violation. This indicates that each QoS violation received 
      from the Monitoring Platform is automatically a QoS violation for the SLA Tool.

    E.g., for the following constraint and monitoring rule:
    
        <constraint id="c1" name="quickaddRT">
            <targetResourceIDRef>EkA9EMhoEeKON4DtRoKCMw</targetResourceIDRef>
            <targetClass>Method</targetClass>
            <metric>ResponseTime</metric>
            <metricAggregation aggregateFunction="Average" />
            <range>
                <hasMaxValue>2000</hasMaxValue>
            </range>
        </constraint>
    
        <monitoringRule id="2bcadcc0-8444-446d-b509-76689641012f" 
                relatedQosConstraintId="c1" startEnabled="true" timeStep="60" timeWindow="60">
            <monitoredTargets>
                <monitoredTarget id="EkA9EMhoEeKON4DtRoKCMw" class="Method"/>
            </monitoredTargets>
            <collectedMetric inherited="false" metricName="ResponseTime">
                <parameter name="samplingProbability">1</parameter>
            </collectedMetric>
            <metricAggregation aggregateFunction="Average"/>
            <condition inherited="false">METRIC &gt; 2.0</condition>
            <actions>
                <action name="OutputMetric">
                    <parameter name="name">qosConstraintc1Violated</parameter>
                </action>
            </actions>
        </monitoringRule>
    
    , the following guarantee term is generated: 
    
        <wsag:GuaranteeTerm wsag:Name="c1">
            <wsag:ServiceScope wsag:ServiceName="service">RequestHandler/quickadd</wsag:ServiceScope>
            <wsag:ServiceLevelObjective>
                <wsag:KPITarget>
                    <wsag:KPIName>ResponseTime</wsag:KPIName>
                    <wsag:CustomServiceLevel>
                        {"constraint": "qosConstraintc1Violated NOTEXISTS", "qos": {"hasMaxValue":2.0}}
                    </wsag:CustomServiceLevel>
                </wsag:KPITarget>
            </wsag:ServiceLevelObjective>
        </wsag:GuaranteeTerm>

An full example of generated template is:

    <wsag:Template wsag:TemplateId="6eb9a0a3-de4d-47fa-ab9d-547055aabe0d" 
            xmlns:wsag="http://www.ggf.org/namespaces/ws-agreement" xmlns:sla="http://sla.atos.eu">
        <wsag:Context>
            <wsag:AgreementResponder>ATOS</wsag:AgreementResponder>
            <wsag:ServiceProvider>AgreementResponder</wsag:ServiceProvider>
            <sla:Service>eHealth Services</sla:Service>
        </wsag:Context>
        <wsag:Terms>
            <wsag:All>
                <wsag:ServiceDescriptionTerm/>
                <wsag:GuaranteeTerm wsag:Name="c1">
                    <wsag:ServiceScope wsag:ServiceName="service">RequestHandler/quickadd</wsag:ServiceScope>
                    <wsag:ServiceLevelObjective>
                        <wsag:KPITarget>
                            <wsag:KPIName>ResponseTime</wsag:KPIName>
                            <wsag:CustomServiceLevel>{"constraint": "qosConstraint_c1_Violated NOTEXISTS", "qos": {"hasMaxValue":2.0}}</wsag:CustomServiceLevel>
                        </wsag:KPITarget>
                    </wsag:ServiceLevelObjective>
                </wsag:GuaranteeTerm>
                <wsag:GuaranteeTerm wsag:Name="c2">
                    <wsag:ServiceScope wsag:ServiceName="service">RequestHandler</wsag:ServiceScope>
                    <wsag:ServiceLevelObjective>
                        <wsag:KPITarget>
                            <wsag:KPIName>ResponseTime</wsag:KPIName>
                            <wsag:CustomServiceLevel>{"constraint": "qosConstraint_c2_Violated NOTEXISTS", "qos": {"hasMaxValue":5.0}}</wsag:CustomServiceLevel>
                        </wsag:KPITarget>
                    </wsag:ServiceLevelObjective>
                </wsag:GuaranteeTerm>
                <wsag:GuaranteeTerm wsag:Name="c3">
                    <wsag:ServiceScope/>
                    <wsag:ServiceLevelObjective>
                        <wsag:KPITarget>
                            <wsag:KPIName>ResponseTime</wsag:KPIName>
                            <wsag:CustomServiceLevel>{"constraint": "qosConstraint_c3_Violated NOTEXISTS", "qos": {"hasMaxValue":1.0}}</wsag:CustomServiceLevel>
                        </wsag:KPITarget>
                    </wsag:ServiceLevelObjective>
                </wsag:GuaranteeTerm>
            </wsag:All>
        </wsag:Terms>
    </wsag:Template>


## <a name="agreement">Agreement generation</a> ##

Several agreements can be created based on a single template, although in the context of MODAClouds,
only one agreement is generated from a template.

The agreement is a copy of the template, with some fields that are not present in the template:
* the customer.
* the expiration time of the agreement.
* the id of the template which this agreement is based on.

    <wsag:Agreement wsag:AgreementId="61a10e1a-b4d3-4282-8c11-1ee34c8716a4" 
            xmlns:wsag="http://www.ggf.org/namespaces/ws-agreement" xmlns:sla="http://sla.atos.eu">
        <wsag:Name></wsag:Name>
        <wsag:Context>
            <wsag:AgreementInitiator>random-consumer</wsag:AgreementInitiator>
            <wsag:AgreementResponder>provider</wsag:AgreementResponder>
            <wsag:ServiceProvider>AgreementResponder</wsag:ServiceProvider>
            <wsag:ExpirationTime>2015-09-03T16:04:52GMT</wsag:ExpirationTime>
            <wsag:TemplateId>59ce6aaf-49e3-4f5a-b9c5-5e63df8388c5</wsag:TemplateId>
            <sla:Service>modaclouds</sla:Service>
        </wsag:Context>
        <wsag:Terms>
            <wsag:All>
                <wsag:ServiceDescriptionTerm/>
                <wsag:GuaranteeTerm wsag:Name="c1">
                    <wsag:ServiceScope wsag:ServiceName="service">RequestHandler/quickadd</wsag:ServiceScope>
                    <wsag:ServiceLevelObjective>
                        <wsag:KPITarget>
                            <wsag:KPIName>ResponseTime</wsag:KPIName>
                            <wsag:CustomServiceLevel>{"constraint": "qosConstraint_c1_Violated EXISTS", "qos": {"hasMaxValue":2.0}}</wsag:CustomServiceLevel>
                        </wsag:KPITarget>
                    </wsag:ServiceLevelObjective>
                </wsag:GuaranteeTerm>
                <wsag:GuaranteeTerm wsag:Name="c2">
                    <wsag:ServiceScope wsag:ServiceName="service">RequestHandler</wsag:ServiceScope>
                    <wsag:ServiceLevelObjective>
                        <wsag:KPITarget>
                            <wsag:KPIName>ResponseTime</wsag:KPIName>
                            <wsag:CustomServiceLevel>{"constraint": "qosConstraint_c2_Violated EXISTS", "qos": {"hasMaxValue":5.0}}</wsag:CustomServiceLevel>
                        </wsag:KPITarget>
                    </wsag:ServiceLevelObjective>
                </wsag:GuaranteeTerm>
                <wsag:GuaranteeTerm wsag:Name="c3">
                    <wsag:ServiceScope></wsag:ServiceScope>
                    <wsag:ServiceLevelObjective>
                        <wsag:KPITarget>
                            <wsag:KPIName>ResponseTime</wsag:KPIName>
                            <wsag:CustomServiceLevel>{"constraint": "qosConstraint_c3_Violated EXISTS", "qos": {"hasMaxValue":1.0}}</wsag:CustomServiceLevel>
                        </wsag:KPITarget>
                    </wsag:ServiceLevelObjective>
                </wsag:GuaranteeTerm>
            </wsag:All>
        </wsag:Terms>
    </wsag:Agreement>
